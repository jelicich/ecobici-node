var ecobici={};ecobici.Panel={data:null,init:function(){},showNotifications:function(t){},getData:function(){}},ecobici.Events={STATIONS_BY_STATUS_LOADED:"stationsByStatusLoaded",USAGE_LOADED:"usageLoaded"},ecobici.DataManager={URL_SERVICE:"/ecobici/",isWaiting:{stationsByStatus:!1,usage:!1},init:function(){var t=io.connect("http://localhost:3003",{forceNew:!0});t.on("messages",function(t){console.log("data pushed from backend"),$(ecobici.DataManager).trigger(ecobici.Events.STATIONS_BY_STATUS_LOADED,[t])})}},ecobici.LeftPanel=$.extend(!0,{},ecobici.Panel,{isUsageRendered:!1,init:function(){console.log("LeftPanel init");var t=this;$(ecobici.DataManager).on(ecobici.Events.USAGE_LOADED,function(a,e){t.updateUsage(e)})},renderUsage:function(t){function a(t,a){var e=d3.interpolate(this._current,t.value);return this._current=t.value,function(n){var i={name:t.name,value:e(n)};return g(i,a)}}var e=$("#graph-bottom-left-1"),n="#graph-bottom-left-1",i=e.width(),r=e.height(),o=25,c=300,t=[{name:"Usadas",value:t},{name:"Disponibles",value:1-t}],s=Math.min(i,r)/3,l=s-.07*s,d=s-.2*s,u=d3.scale.ordinal().range([d3.rgb("#a30919"),d3.rgb("#31a354")]),g=(d3.select(n).append("svg").attr("id","svg-usage").attr("width",i).attr("height",r),d3.svg.arc().outerRadius(l).innerRadius(d)),p=d3.layout.pie().sort(null).value(function(t){return t.value}),f=d3.select("svg#svg-usage").append("g").attr("transform","translate("+i/2+","+r/2+")"),h=f.selectAll(".arc").data(p(t)).enter().append("g").attr("class","arc"),v=h.append("path");v.transition().duration(c).attr("fill",function(t){return u(t.value)}).attrTween("d",a);t.value;h.append("text").text(function(t){var a=(100*t.value).toFixed(2);return a+"%"}).attr("transform",function(t,a){var e=this.getBBox(),n=e.width,r=0==a?i/2-n-o:-i/2+o;return"translate("+r+" , "+(s+40)+")"}).attr("dy",".35em"),h.append("text").text(function(t){return t.data.name}).attr("font-weight","bold").attr("transform",function(t,a){var e=this.getBBox(),n=e.width,r=0==a?i/2-n-o:-i/2+o;return"translate("+r+" , "+(s+20)+")"}).attr("dy",".35em").attr("class","device-name").style("fill",function(t){return u(t.value)})},updateUsage:function(t){ecobici.LeftPanel.isUsageRendered||ecobici.LeftPanel.renderUsage(t);var a=$("#graph-bottom-left-1"),e=a.width(),n=a.height(),i=Math.min(e,n)/3,r=i-.07*i,o=i-.2*i,c=d3.svg.arc().outerRadius(r).innerRadius(o),s=d3.select("svg#svg-usage"),l=s.selectAll("path");l.data(t).enter().attr("d",c).style("fill",function(t){return color(t.value)})}}),$(document).ready(function(){ecobici.DataManager.init(),ecobici.TopPanel.init()}),ecobici.RightPanel=$.extend(!0,{},ecobici.Panel,{data:null,isRendered:!1,init:function(){console.log("RightPanel init");var t=this;$(ecobici.DataManager).on(ecobici.Events.STATIONS_BY_STATUS_LOADED,function(a,e){t.data=e,t.updateMap(e)})},loadData:function(t){if(this.data=ecobici.TopPanel.getData(),"undefined"!=typeof t)for(var a=0;a<t.length;a++)t[a](this.data)},printMap:function(t){var a=this;a.map=new L.Map("graph-bottom-right",{center:[-34.6,-58.4],zoom:11}).addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")),a.map._initPathRoot();for(var e=d3.select("#graph-bottom-right").select("svg"),n=e.append("g"),i=0;i<t.length;i++){var r=t[i].Latitud,o=t[i].Longitud;t[i].LatLng=new L.LatLng(r,o)}n.selectAll("circle.circle-station").data(t).enter().append("circle").style("stroke","black").style("opacity",.6).attr("class","circle-station").attr({r:10,class:"circle-station"});a.map.on("viewreset",function(){ecobici.RightPanel.updateMap(a.data)}),ecobici.RightPanel.isRendered=!0},updateMap:function(t){var a=this;ecobici.RightPanel.isRendered||ecobici.RightPanel.printMap(t);for(var e=d3.min(t,function(t){return t.CantidadBicicletas}),n=d3.scale.linear().domain([0,e]).range([d3.rgb("#a30919"),d3.rgb("#31a354")]),i=0;i<t.length;i++){var r=t[i].Latitud,o=t[i].Longitud;t[i].LatLng=new L.LatLng(r,o)}var c=d3.select("#graph-bottom-right").select("svg"),s=c.select("g").selectAll("circle.circle-station").data(t);s.attr({transform:function(t){return"translate("+a.map.latLngToLayerPoint(t.LatLng).x+","+a.map.latLngToLayerPoint(t.LatLng).y+")"},r:10,fill:function(t){return n(t.BicicletaDisponibles)}})},showNotifications:function(t){},getData:function(){}}),ecobici.TopPanel=$.extend(!0,{},ecobici.Panel,{UPDATE_TIME:5e3,data:null,isWaiting:!1,interval:null,isRendered:!1,status:"*",init:function(){console.log("TopPanel init");var t=this;$(ecobici.DataManager).on(ecobici.Events.STATIONS_BY_STATUS_LOADED,function(a,e){t.updateBikesAvailable(e)}),$(window).on("resize",function(){t.updateBikesAvailable(ecobici.TopPanel.getData())})},setUpTopChart:function(t){var a=t,e=$("#graph-top"),n="#graph-top",i=e.width(),r=e.height(),o=25,c=d3.scale.ordinal().domain(["Estaciones"]).rangeRoundBands([0,i-o-1],.1),s=d3.svg.axis().scale(c).orient("bottom"),l=d3.scale.linear().domain([0,d3.max(a,function(t){return t.CantidadBicicletas})]).range([r-o,0]),d=d3.svg.axis().scale(l).orient("left"),u=d3.select(n).append("svg").attr("width",i).attr("height",r);u.append("g").call(s).attr("class","x-axis").attr("transform","translate("+o+","+(r-o)+")"),u.append("g").call(d).attr("class","y-axis").attr("transform","translate("+o+",0)");this.isRendered=!0},updateBikesAvailable:function(t){ecobici.TopPanel.isRendered||ecobici.TopPanel.setUpTopChart(t);var a=$("#graph-top"),e="#graph-top",n=a.width(),i=a.height(),r=.003*n,o=25,c=d3.select("#graph-top-tooltip"),s="#31a354",l="#a30919",d="#cccccc",u=d3.max(t,function(t){return t.CantidadBicicletas}),g=d3.scale.linear().domain([0,u]).range([d3.rgb(l),d3.rgb(s)]),p=function(t){var a;return a="disponible"!=t.Estado?d:g(t.CantidadBicicletas)},f=d3.scale.ordinal().domain(["Estaciones"]).rangeRoundBands([0,n-o-1],.1),h=d3.svg.axis().scale(f).orient("bottom"),v=d3.scale.linear().domain([0,d3.max(t,function(t){return t.CantidadBicicletas})]).range([i-o,0]),b=d3.svg.axis().scale(v).orient("left"),m=d3.select(e).select("svg");m.attr("width",n).attr("height",i);var L=(m.selectAll("g.x-axis").call(h).attr("transform","translate("+o+","+(i-o)+")"),m.selectAll("g.y-axis").call(b),m.selectAll(".bar").data(t));L.enter().append("rect").attr({class:"bar",x:function(a,e){return e*((n-o)/t.length)+o+r},y:function(t){return v(t.CantidadBicicletas)},height:function(t){return i-o-v(t.CantidadBicicletas)},width:n/t.length-r,fill:function(t){return p(t)}}).on("mouseover",function(t){c.select(".title").html(t.Nombre);var a=g(t.CantidadBicicletas);c.select(".content").html('<ul><li><strong style="color:'+a+'">Cantidad: '+t.CantidadBicicletas+"</strong></li><li>Estado: "+t.Estado+"</li><li>Anclajes Disponibles: NaN"),c.transition().duration(200).style("opacity",.85)}).on("mouseout",function(t){c.transition().duration(400).style("opacity",0)}),L.exit().remove(),L.transition().duration(500).attr({x:function(a,e){return e*((n-o)/t.length)+o+r},y:function(t){return v(t.CantidadBicicletas)},height:function(t){return i-o-v(t.CantidadBicicletas)},width:n/t.length-r,fill:function(t){return p(t)}}),$("g.x-axis",a).appendTo(a.find("svg")),$("g.y-axis",a).appendTo(a.find("svg"))},showNotifications:function(t){},getData:function(){return this.data}}),$(document).ready(function(){DataManager.init(),TopPanel.init()});